<? $this->headScript()->appendFile('vendor/flickity.pkgd.min.js'); ?>
<? $this->headLink()->appendStylesheet('vendor/flickity.min.css'); ?>
<? foreach ($channels as $key=>$channel): ?>
  <h2><?=$this->escapeHtml($channel['title'])?></h2>
  <? $channelID = 'channel-' . $key; ?>
  <div id="<?=$channelID ?>" class="channel">
    <!-- Wrapper for slides -->
    <? foreach ($channel['contents'] as $item): ?>
      <a href="<?=$this->recordLink()->getUrl("{$item['source']}|{$item['id']}")?>" class="channel-record" data-record-id="<?=$this->escapeHtmlAttr($item['id']) ?>" data-record-source="<?=$item['source'] ?>">
        <div class="img" style="background-image:url(http://placehold.it/<?=rand(100, 150) ?>x<?=rand(150, 200) ?>)"></div>
        <?=$this->escapeHtml($item['title'])?>
      </a>
    <? endforeach; ?>
  </div>
<? endforeach; ?>
<?
  $script = <<<JS
$('.channel').flickity({
  cellAlign: 'left',
  contain: true,
  pageDots: false
});
$('.channel-record').click(function channelRecord() { return false; });
$('.channel').on('staticClick', function(event, pointer, cellElement, cellIndex) {
  console.log(event);
  event.originalEvent.preventDefault();
  var record = $(cellElement);
  if (record.data('popover')) {
    record.popover('toggle');
  } else {
    record.data('popover', true);
    record.popover({
      content: VuFind.translate('loading')+'...',
      html: true,
      placement: 'bottom',
      trigger: 'focus',
      container: '#'+record.closest('.channel').attr('id')
    });
    record.popover('show');
    $.ajax({
      url: VuFind.path + getUrlRoot(record.attr('href')) + '/AjaxTab',
      type: 'POST',
      data: {tab: 'description'}
    })
    .done(function(data) {
      record.data('bs.popover').options.content = '<h2>'+record.text()+'</h2>'
        + '<div class="btn-group btn-group-justified">'
        + '<a href="'+VuFind.path+'/Channels/Record?'
          + 'id=' + encodeURIComponent(record.attr('data-record-id'))
          + '&source=' + encodeURIComponent(record.attr('data-record-source'))
        +'" class="btn btn-default">More Like This</a>'
        + '<a href="'+record.attr('href')+'" class="btn btn-default">Go To Record</a>'
        + '</div>'
        + data;
      record.popover('show');
    });
  }
  return false;
});
JS;
?>
<?=$this->inlineScript(\Zend\View\Helper\HeadScript::SCRIPT, $script, 'SET'); ?>
